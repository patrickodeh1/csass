{% extends 'base.html' %}

{% block title %}Time Slots - CSASS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 align-items-start">
        <div class="col">
            <h2><i class="bi bi-clock-history"></i> Time Slots Management</h2>
            {% if not is_admin %}
                <p class="text-muted mb-0">Manage your availability and auto-generation settings</p>
            {% endif %}
        </div>
        <div class="col-auto">
            <div class="d-flex gap-2 flex-wrap">
                {% if is_admin %}
                <button type="button" class="btn btn-danger" id="bulkDeleteBtn" style="display: none;">
                    <i class="bi bi-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
                </button>
                <a href="{% url 'timeslot_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Create Slot
                </a>
                {% endif %}
                
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateSlotsModal">
                    <i class="bi bi-lightning-charge"></i> Generate Slots
                </button>
                
                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#autogenSettingsModal">
                    <i class="bi bi-gear"></i> Auto-generation Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <form method="get" class="card mb-4 p-3 shadow-sm border-0">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-semibold">Cycle</label>
                <select name="cycle" class="form-select" onchange="this.form.submit()">
                    {% for c in cycles %}
                    <option value="{{ c.id }}" {% if selected_cycle.id == c.id %}selected{% endif %}>
                        {{ c.start_date|date:"M d" }} - {{ c.end_date|date:"M d, Y" }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% if is_admin %}
            <div class="col-md-3">
                <label class="form-label fw-semibold">Salesman</label>
                <select name="salesman" class="form-select" onchange="this.form.submit()">
                    <option value="">All Salesmen</option>
                    {% for s in salesmen %}
                    <option value="{{ s.id }}" {% if selected_salesman == s.id|stringformat:'s' %}selected{% endif %}>
                        {{ s.get_full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-2">
                <label class="form-label fw-semibold">Type</label>
                <select name="type" class="form-select" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="zoom" {% if selected_type == 'zoom' %}selected{% endif %}>Zoom</option>
                    <option value="in_person" {% if selected_type == 'in_person' %}selected{% endif %}>In-Person</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold">Date</label>
                <input type="date" name="day" class="form-control" value="{{ selected_day }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-secondary w-100">
                    <i class="bi bi-filter"></i> Filter
                </button>
            </div>
        </div>
    </form>

    <!-- Meeting Types Status Alert -->
    <div class="alert alert-info mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <strong><i class="bi bi-info-circle"></i> Meeting Types Status:</strong><br>
                <span class="badge bg-{% if config.zoom_enabled %}success{% else %}secondary{% endif %} me-2">
                    <i class="bi bi-camera-video"></i> Zoom: {% if config.zoom_enabled %}Enabled{% else %}Disabled{% endif %}
                </span>
                <span class="badge bg-{% if config.in_person_enabled %}success{% else %}secondary{% endif %}">
                    <i class="bi bi-geo-alt"></i> In-Person: {% if config.in_person_enabled %}Enabled{% else %}Disabled{% endif %}
                </span>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    Only enabled meeting types will be generated. 
                    {% if is_admin %}
                        <a href="{% url 'settings' %}" class="alert-link">Change in Settings</a>
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Mass Delete Form -->
    <form method="post" id="bulkDeleteForm" action="{% url 'timeslots' %}">
        {% csrf_token %}
        <input type="hidden" name="bulk_action" value="delete">
        
        <div class="card shadow border-0">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    Time Slots ({{ page_obj.paginator.count }} total)
                    {% if current_salesman %}
                        - {{ current_salesman.get_full_name }}
                    {% elif not is_admin %}
                        - {{ request.user.get_full_name }}
                    {% endif %}
                </h5>
                {% if is_admin %}
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                    <label class="form-check-label text-white" for="selectAll">
                        Select All on Page
                    </label>
                </div>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                {% if is_admin %}
                                <th style="width: 40px;">
                                    <i class="bi bi-check-square"></i>
                                </th>
                                {% endif %}
                                <th>Date</th>
                                <th>Time</th>
                                <th>Salesman</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in page_obj %}
                            <tr class="{% if not slot.is_active %}table-secondary{% endif %}">
                                {% if is_admin %}
                                <td>
                                    <input type="checkbox" class="form-check-input slot-checkbox" 
                                           name="slot_ids" value="{{ slot.id }}">
                                </td>
                                {% endif %}
                                <td>
                                    <span class="badge bg-secondary">{{ slot.date|date:"D, M d" }}</span>
                                </td>
                                <td><strong>{{ slot.start_time|time:"g:i A" }}</strong></td>
                                <td>{{ slot.salesman.get_full_name }}</td>
                                <td>
                                    <span class="badge bg-{% if slot.appointment_type == 'zoom' %}info{% else %}primary{% endif %}">
                                        {% if slot.appointment_type == 'zoom' %}
                                            <i class="bi bi-camera-video"></i> Zoom
                                        {% else %}
                                            <i class="bi bi-geo-alt"></i> In-Person
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if slot.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'timeslot_edit' slot.id %}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'timeslot_delete' slot.id %}" class="btn btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{% if is_admin %}7{% else %}6{% endif %}" class="text-center text-muted py-5">
                                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                    <p class="mt-3">No time slots found</p>
                                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateSlotsModal">
                                        <i class="bi bi-lightning-charge"></i> Generate Slots
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="card-footer bg-light">
                <nav aria-label="Pagination">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if selected_cycle %}&cycle={{ selected_cycle.id }}{% endif %}{% if selected_salesman %}&salesman={{ selected_salesman }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_day %}&day={{ selected_day }}{% endif %}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_cycle %}&cycle={{ selected_cycle.id }}{% endif %}{% if selected_salesman %}&salesman={{ selected_salesman }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_day %}&day={{ selected_day }}{% endif %}">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                        </li>
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_cycle %}&cycle={{ selected_cycle.id }}{% endif %}{% if selected_salesman %}&salesman={{ selected_salesman }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_day %}&day={{ selected_day }}{% endif %}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if selected_cycle %}&cycle={{ selected_cycle.id }}{% endif %}{% if selected_salesman %}&salesman={{ selected_salesman }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_day %}&day={{ selected_day }}{% endif %}">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Generate Slots Modal (NEW) -->
<div class="modal fade" id="generateSlotsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-lightning-charge-fill"></i> Generate Slots
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="generateSlotsForm">
                {% csrf_token %}
                <input type="hidden" name="trigger_generation" value="1">
                <div class="modal-body">
                    {% if is_admin %}
                    <!-- Admin: Select Salesman -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Salesman</label>
                        <select name="target_salesman" class="form-select" required id="targetSalesmanGenerate">
                            <option value="">-- Select Salesman --</option>
                            {% for s in salesmen %}
                            <option value="{{ s.id }}" {% if current_salesman and current_salesman.id == s.id %}selected{% endif %}>
                                {{ s.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Choose which salesman to generate slots for
                        </small>
                    </div>
                    {% else %}
                    <!-- Salesman: Auto-set to current user -->
                    <input type="hidden" name="target_salesman" value="{{ request.user.id }}">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Generating slots for: <strong>{{ request.user.get_full_name }}</strong>
                    </div>
                    {% endif %}

                    <hr>

                    <div class="alert alert-warning">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Meeting Types</h6>
                        <p class="mb-2">The following meeting types will be generated based on system settings:</p>
                        <ul class="mb-0">
                            {% if config.zoom_enabled %}
                            <li><span class="badge bg-info"><i class="bi bi-camera-video"></i> Zoom</span> - Enabled</li>
                            {% endif %}
                            {% if config.in_person_enabled %}
                            <li><span class="badge bg-primary"><i class="bi bi-geo-alt"></i> In-Person</span> - Enabled</li>
                            {% endif %}
                            {% if not config.zoom_enabled and not config.in_person_enabled %}
                            <li class="text-danger">⚠️ No meeting types are enabled!</li>
                            {% endif %}
                        </ul>
                        {% if is_admin %}
                        <small class="text-muted d-block mt-2">
                            <a href="{% url 'settings' %}" class="alert-link">Change meeting type settings</a>
                        </small>
                        {% endif %}
                    </div>

                    {% if not config.zoom_enabled and not config.in_person_enabled %}
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Cannot generate slots. Please enable at least one meeting type in system settings.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success" {% if not config.zoom_enabled and not config.in_person_enabled %}disabled{% endif %}>
                        <i class="bi bi-lightning-charge"></i> Generate Slots</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Auto-generation Settings Modal -->
<div class="modal fade" id="autogenSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-gear-fill"></i> Slot Auto-generation Settings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="autogenSettingsForm">
                {% csrf_token %}
                <input type="hidden" name="update_autogen_settings" value="1">
                <div class="modal-body">
                    {% if is_admin %}
                    <!-- Admin: Select Salesman -->
                    <div class="mb-4 pb-3 border-bottom">
                        <label class="form-label fw-bold">Select Salesman</label>
                        <select name="target_salesman" class="form-select" required id="targetSalesmanSettings">
                            <option value="">-- Select Salesman --</option>
                            {% for s in salesmen %}
                            <option value="{{ s.id }}" 
                                    data-advance-days="{{ s.booking_advance_days }}"
                                    data-start-time="{{ s.booking_start_time|time:'H:i' }}"
                                    data-end-time="{{ s.booking_end_time|time:'H:i' }}"
                                    data-weekdays="{{ s.booking_weekdays }}"
                                    {% if current_salesman and current_salesman.id == s.id %}selected{% endif %}>
                                {{ s.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Choose which salesman's settings to configure
                        </small>
                    </div>
                    {% else %}
                    <!-- Salesman: Auto-set to current user -->
                    <input type="hidden" name="target_salesman" value="{{ request.user.id }}">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-person-circle"></i>
                        Configuring settings for: <strong>{{ request.user.get_full_name }}</strong>
                    </div>
                    {% endif %}

                    <div class="alert alert-success mb-4">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Personal Slot Generation Settings</strong><br>
                        Configure how your appointment slots are automatically generated.
                    </div>

                    <!-- Generation Window -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-calendar-range"></i> Generation Window
                    </h6>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Days in Advance</label>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="number" 
                                       class="form-control" 
                                       name="booking_advance_days" 
                                       id="bookingAdvanceDays"
                                       min="1" 
                                       max="365" 
                                       value="{{ booking_advance_days|default:14 }}"
                                       required>
                                <span class="input-group-text">days</span>
                            </div>
                            <small class="form-text text-muted d-block mt-1">
                                How far ahead to generate your appointment slots (1-365 days).<br>
                                <strong>Example:</strong> If set to 14 days, slots will be generated for the next 2 weeks.
                            </small>
                        </div>
                    </div>

                    <hr>

                    <!-- Daily Time Range -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-clock"></i> Daily Time Range
                    </h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Start Time</label>
                            <input type="time" 
                                   class="form-control" 
                                   name="booking_start_time" 
                                   id="bookingStartTime"
                                   value="{% if booking_start_time %}{{ booking_start_time|time:'H:i' }}{% else %}09:00{% endif %}"
                                   required>
                            <small class="form-text text-muted d-block mt-1">
                                Earliest time for daily appointments
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">End Time</label>
                            <input type="time" 
                                   class="form-control" 
                                   name="booking_end_time" 
                                   id="bookingEndTime"
                                   value="{% if booking_end_time %}{{ booking_end_time|time:'H:i' }}{% else %}19:00{% endif %}"
                                   required>
                            <small class="form-text text-muted d-block mt-1">
                                Latest time for daily appointments
                            </small>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Note:</strong> Slots are generated in 30-minute intervals between start and end times.
                    </div>

                    <hr>

                    <!-- Active Days of Week -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-calendar-week"></i> Active Days
                    </h6>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Generate slots on these days:</label>
                        <div class="row" id="weekdayCheckboxes">
                            {% for value, label in weekday_choices %}
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input weekday-checkbox" type="checkbox" 
                                           name="booking_weekdays_display" 
                                           value="{{ value }}" 
                                           id="weekday_{{ value }}"
                                           {% if value in booking_weekdays_selected %}checked{% endif %}>
                                    <label class="form-check-label" for="weekday_{{ value }}">
                                        {{ label }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted d-block mt-2">
                            Select which days of the week to accept appointments
                        </small>
                    </div>

                    <hr>

                    <!-- Meeting Types Info -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-calendar2-check"></i> Meeting Types
                    </h6>
                    <div class="alert alert-light border">
                        <p class="mb-2"><strong>Generated Meeting Types (from System Settings):</strong></p>
                        <div class="mb-2">
                            {% if config.zoom_enabled %}
                            <span class="badge bg-info me-2">
                                <i class="bi bi-camera-video"></i> Zoom - Will be generated
                            </span>
                            {% else %}
                            <span class="badge bg-secondary me-2">
                                <i class="bi bi-camera-video"></i> Zoom - Disabled
                            </span>
                            {% endif %}
                            
                            {% if config.in_person_enabled %}
                            <span class="badge bg-primary">
                                <i class="bi bi-geo-alt"></i> In-Person - Will be generated
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-geo-alt"></i> In-Person - Disabled
                            </span>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {% if not config.zoom_enabled and not config.in_person_enabled %}
                            <span class="text-danger">⚠️ No meeting types are enabled. Slot generation will fail.</span>
                            {% elif config.zoom_enabled and config.in_person_enabled %}
                            Both Zoom and In-Person slots will be generated for each time interval.
                            {% elif config.zoom_enabled %}
                            Only Zoom slots will be generated.
                            {% else %}
                            Only In-Person slots will be generated.
                            {% endif %}
                            {% if is_admin %}
                            <a href="{% url 'settings' %}" class="alert-link">Change in Settings</a>
                            {% endif %}
                        </small>
                    </div>

                    <hr>

                    <!-- Current Configuration Summary -->
                    <div class="alert alert-light border">
                        <h6 class="alert-heading">
                            <i class="bi bi-list-check"></i> Configuration Summary
                        </h6>
                        <ul class="mb-0" id="configSummary">
                            <li><strong>Window:</strong> <span id="summaryDays">{{ booking_advance_days|default:14 }}</span> days ahead</li>
                            <li><strong>Time Range:</strong> 
                                <span id="summaryTime">
                                {% if booking_start_time and booking_end_time %}
                                {{ booking_start_time|time:"g:i A" }} - {{ booking_end_time|time:"g:i A" }}
                                {% else %}
                                9:00 AM - 7:00 PM
                                {% endif %}
                                </span>
                            </li>
                            <li><strong>Active Days:</strong> 
                                <span id="summaryDays">
                                {% if booking_weekdays_selected %}
                                    {% for day in booking_weekdays_selected %}
                                        {% if day == '0' %}Mon{% elif day == '1' %}Tue{% elif day == '2' %}Wed{% elif day == '3' %}Thu{% elif day == '4' %}Fri{% elif day == '5' %}Sat{% elif day == '6' %}Sun{% endif %}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Mon-Fri
                                {% endif %}
                                </span>
                            </li>
                            <li><strong>Slot Interval:</strong> 30 minutes</li>
                            <li><strong>Meeting Types:</strong> 
                                {% if config.zoom_enabled and config.in_person_enabled %}
                                    Zoom & In-Person
                                {% elif config.zoom_enabled %}
                                    Zoom only
                                {% elif config.in_person_enabled %}
                                    In-Person only
                                {% else %}
                                    <span class="text-danger">None enabled</span>
                                {% endif %}
                            </li>
                            <li class="mt-2 text-muted">
                                <small>
                                    <i class="bi bi-lightbulb"></i> 
                                    After saving settings, click "Generate Slots" to create your availability.
                                </small>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bulk delete functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const slotCheckboxes = document.querySelectorAll('.slot-checkbox');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectedCount = document.getElementById('selectedCount');
    const bulkDeleteForm = document.getElementById('bulkDeleteForm');
    
    function updateBulkDeleteBtn() {
        const checkedBoxes = document.querySelectorAll('.slot-checkbox:checked');
        const count = checkedBoxes.length;
        if (selectedCount) {
            selectedCount.textContent = count;
        }
        if (bulkDeleteBtn) {
            bulkDeleteBtn.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            slotCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkDeleteBtn();
        });
    }
    
    slotCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkDeleteBtn();
            
            const allChecked = Array.from(slotCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(slotCheckboxes).some(cb => cb.checked);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        });
    });
    
    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', function() {
            const count = document.querySelectorAll('.slot-checkbox:checked').length;
            if (confirm(`Are you sure you want to delete ${count} selected slot(s)? This action cannot be undone.`)) {
                bulkDeleteForm.submit();
            }
        });
    }

    // Admin: Auto-load salesman settings when selected in settings modal
    const targetSalesmanSettings = document.getElementById('targetSalesmanSettings');
    if (targetSalesmanSettings) {
        targetSalesmanSettings.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                // Update form fields with selected salesman's data
                const advanceDays = selectedOption.getAttribute('data-advance-days') || 14;
                const startTime = selectedOption.getAttribute('data-start-time') || '09:00';
                const endTime = selectedOption.getAttribute('data-end-time') || '19:00';
                const weekdays = selectedOption.getAttribute('data-weekdays') || '0,1,2,3,4';
                
                document.getElementById('bookingAdvanceDays').value = advanceDays;
                document.getElementById('bookingStartTime').value = startTime;
                document.getElementById('bookingEndTime').value = endTime;
                
                // Update weekday checkboxes
                const weekdayArray = weekdays.split(',');
                document.querySelectorAll('.weekday-checkbox').forEach(checkbox => {
                    checkbox.checked = weekdayArray.includes(checkbox.value);
                });
                
                // Update summary
                updateSummary();
            }
        });
    }

    // Real-time summary update
    function updateSummary() {
        const days = document.getElementById('bookingAdvanceDays')?.value || 14;
        const startTime = document.getElementById('bookingStartTime')?.value || '09:00';
        const endTime = document.getElementById('bookingEndTime')?.value || '19:00';
        
        if (document.getElementById('summaryDays')) {
            document.getElementById('summaryDays').textContent = days;
        }
        
        // Format time display
        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }
        
        if (document.getElementById('summaryTime')) {
            document.getElementById('summaryTime').textContent = 
                `${formatTime(startTime)} - ${formatTime(endTime)}`;
        }
        
        // Update selected days summary
        const checkedDays = Array.from(document.querySelectorAll('.weekday-checkbox:checked'));
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const selectedDaysText = checkedDays.map(cb => dayNames[parseInt(cb.value)]).join(', ') || 'None';
        
        const summaryDaysElement = document.querySelector('#configSummary #summaryDays');
        if (summaryDaysElement) {
            summaryDaysElement.textContent = selectedDaysText;
        }
    }

    // Add event listeners for real-time updates
    const formInputs = ['bookingAdvanceDays', 'bookingStartTime', 'bookingEndTime'];
    formInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateSummary);
        }
    });

    document.querySelectorAll('.weekday-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSummary);
    });
});
</script>
{% endblock %}